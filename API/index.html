
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mechanistic Interpretability for MLX on Apple Silicon">
      
      
        <meta name="author" content="Sigurd Schacht">
      
      
        <link rel="canonical" href="https://github.com/coairesearch/mlxterp/API/">
      
      
        <link rel="prev" href="../examples/">
      
      
        <link rel="next" href="../tutorials/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API Reference - mlxterp</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mlxterp-api-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="mlxterp" class="md-header__button md-logo" aria-label="mlxterp" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            mlxterp
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/coairesearch/mlxterp" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    coairesearch/mlxterp
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../QUICKSTART/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../examples/" class="md-tabs__link">
          
  
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../tutorials/" class="md-tabs__link">
          
  
  
  Tutorials (Paper Reproductions)

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/activation_patching/" class="md-tabs__link">
          
  
  
  Guides & Procedures

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../architecture/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../license/" class="md-tabs__link">
          
  
  
  About

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="mlxterp" class="md-nav__button md-logo" aria-label="mlxterp" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    mlxterp
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/coairesearch/mlxterp" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    coairesearch/mlxterp
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../QUICKSTART/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Examples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interpretablemodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        InterpretableModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InterpretableModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-interpretablemodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: InterpretableModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: InterpretableModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Constructor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-encode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: encode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-decode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: decode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-encode_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: encode_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-token_to_str" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: token_to_str
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-vocab_size" class="md-nav__link">
    <span class="md-ellipsis">
      
        Property: vocab_size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: tokenizer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-get_token_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: get_token_predictions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-logit_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: logit_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-train_tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: train_tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-load_tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: load_tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-activation_patching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: activation_patching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-named_modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: named_modules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-output" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: output
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: Trace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: Trace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Methods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getname-str-optionalmxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        get(name: str) -&gt; Optional[mx.array]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_activationname-str-optionalmxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_activation(name: str) -&gt; Optional[mx.array]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-outputproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: OutputProxy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: OutputProxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-save-any" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: save() -&gt; Any
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interventions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-mlxterpinterventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module: mlxterp.interventions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-zero_out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: zero_out
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-scale" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: scale
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-add_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: add_vector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-replace_with" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: replace_with
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-clamp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: clamp
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-noise" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: noise
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-interventioncomposer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: InterventionComposer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: InterventionComposer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-add" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: add
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-build" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: build
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-interventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Interventions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Utilities
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-get_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: get_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-batch_get_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: batch_get_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-collect_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: collect_activations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Components
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-moduleproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ModuleProxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-layerlistproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: LayerListProxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-activationcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ActivationCache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-moduleresolver" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ModuleResolver
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-tunedlens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: TunedLens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-normalize_layer_key" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: normalize_layer_key
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-find_layer_key_pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: find_layer_key_pattern
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Annotations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Exceptions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valueerror" class="md-nav__link">
    <span class="md-ellipsis">
      
        ValueError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attributeerror" class="md-nav__link">
    <span class="md-ellipsis">
      
        AttributeError
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-always-use-context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Always Use Context Managers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-save-early-access-later" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Save Early, Access Later
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-use-utility-functions-for-common-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Use Utility Functions for Common Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-batch-large-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Batch Large Datasets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Version History
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version History">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#010-current" class="md-nav__link">
    <span class="md-ellipsis">
      
        0.1.0 (Current)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials (Paper Reproductions)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials (Paper Reproductions)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/01_logit_lens/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Logit Lens
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/02_tuned_lens/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Tuned Lens
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/03_causal_tracing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Causal Tracing (ROME)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/04_steering_vectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Steering Vectors (CAA)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/05_induction_heads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Induction Heads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/06_sparse_autoencoders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Sparse Autoencoders
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides & Procedures
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides & Procedures
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/activation_patching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Activation Patching
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/dictionary_learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dictionary Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/sae_evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SAE Evaluation & Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/sae_feature_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SAE Feature Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    About
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    License
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../citation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Citation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      
        Table of Contents
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interpretablemodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        InterpretableModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InterpretableModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-interpretablemodel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: InterpretableModel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: InterpretableModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constructor" class="md-nav__link">
    <span class="md-ellipsis">
      
        Constructor
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-encode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: encode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-decode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: decode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-encode_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: encode_batch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-token_to_str" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: token_to_str
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#property-vocab_size" class="md-nav__link">
    <span class="md-ellipsis">
      
        Property: vocab_size
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-tokenizer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: tokenizer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-get_token_predictions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: get_token_predictions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-logit_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: logit_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-train_tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: train_tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-load_tuned_lens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: load_tuned_lens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-activation_patching" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: activation_patching
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-named_modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: named_modules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-layers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: layers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-output" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attribute: output
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: Trace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: Trace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#attributes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Attributes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Methods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getname-str-optionalmxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        get(name: str) -&gt; Optional[mx.array]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_activationname-str-optionalmxarray" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_activation(name: str) -&gt; Optional[mx.array]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-outputproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: OutputProxy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: OutputProxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-save-any" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: save() -&gt; Any
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interventions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#module-mlxterpinterventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module: mlxterp.interventions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-zero_out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: zero_out
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-scale" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: scale
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-add_vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: add_vector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-replace_with" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: replace_with
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-clamp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: clamp
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-noise" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: noise
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-interventioncomposer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: InterventionComposer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Class: InterventionComposer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#method-add" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: add
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-build" class="md-nav__link">
    <span class="md-ellipsis">
      
        Method: build
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-interventions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Custom Interventions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Utilities
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-get_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: get_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-batch_get_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: batch_get_activations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-collect_activations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: collect_activations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Components
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#class-moduleproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ModuleProxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-layerlistproxy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: LayerListProxy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-activationcache" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ActivationCache
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-moduleresolver" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: ModuleResolver
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#class-tunedlens" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class: TunedLens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-normalize_layer_key" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: normalize_layer_key
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#function-find_layer_key_pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Function: find_layer_key_pattern
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type Annotations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Exceptions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valueerror" class="md-nav__link">
    <span class="md-ellipsis">
      
        ValueError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attributeerror" class="md-nav__link">
    <span class="md-ellipsis">
      
        AttributeError
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      
        Best Practices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-always-use-context-managers" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Always Use Context Managers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-save-early-access-later" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Save Early, Access Later
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-use-utility-functions-for-common-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Use Utility Functions for Common Tasks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-batch-large-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Batch Large Datasets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        Version History
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Version History">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#010-current" class="md-nav__link">
    <span class="md-ellipsis">
      
        0.1.0 (Current)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="mlxterp-api-documentation">mlxterp API Documentation<a class="headerlink" href="#mlxterp-api-documentation" title="Permanent link">&para;</a></h1>
<p>Complete API reference for mlxterp.</p>
<h2 id="table-of-contents">Table of Contents<a class="headerlink" href="#table-of-contents" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="#interpretablemodel">InterpretableModel</a></li>
<li><a href="#tracing">Tracing</a></li>
<li><a href="#interventions">Interventions</a></li>
<li><a href="#utilities">Utilities</a></li>
<li><a href="#core-components">Core Components</a></li>
</ol>
<hr />
<h2 id="interpretablemodel">InterpretableModel<a class="headerlink" href="#interpretablemodel" title="Permanent link">&para;</a></h2>
<h3 id="class-interpretablemodel">Class: <code>InterpretableModel</code><a class="headerlink" href="#class-interpretablemodel" title="Permanent link">&para;</a></h3>
<p>Main entry point for wrapping MLX models to add interpretability features.</p>
<h4 id="constructor">Constructor<a class="headerlink" href="#constructor" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">InterpretableModel</span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">layer_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">embedding_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">norm_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">lm_head_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>model</strong> (<code>nn.Module</code> or <code>str</code>): Either:</li>
<li>An MLX <code>nn.Module</code> instance to wrap</li>
<li>
<p>A model name/path string (attempts to load via <code>mlx_lm.load()</code>)</p>
</li>
<li>
<p><strong>tokenizer</strong> (<code>Optional[Any]</code>): Tokenizer for processing text inputs. If <code>None</code> and model is loaded from string, attempts to load tokenizer automatically.</p>
</li>
<li>
<p><strong>layer_attr</strong> (<code>str</code>, default: <code>"layers"</code>): Name of the attribute containing the model's transformer layers. Common values:</p>
</li>
<li><code>"layers"</code> (Llama, Mistral)</li>
<li><code>"h"</code> (GPT-2)</li>
<li>
<p><code>"transformer.h"</code> (some GPT variants)</p>
</li>
<li>
<p><strong>embedding_path</strong> (<code>Optional[str]</code>, default: <code>None</code>): Override path for the token embedding layer. Used for weight-tied output projection in <code>get_token_predictions</code>. Auto-detected if not specified. Tried paths: <code>model.embed_tokens</code>, <code>model.model.embed_tokens</code>, <code>embed_tokens</code>, <code>tok_embeddings</code>, <code>wte</code>.</p>
</li>
<li>
<p><strong>norm_path</strong> (<code>Optional[str]</code>, default: <code>None</code>): Override path for the final layer normalization. Used in <code>logit_lens</code> for projecting intermediate activations. Auto-detected if not specified. Tried paths: <code>model.norm</code>, <code>model.model.norm</code>, <code>norm</code>, <code>ln_f</code>, <code>model.ln_f</code>.</p>
</li>
<li>
<p><strong>lm_head_path</strong> (<code>Optional[str]</code>, default: <code>None</code>): Override path for the output projection layer. If not found, falls back to weight-tied embedding. Tried paths: <code>lm_head</code>, <code>model.lm_head</code>, <code>model.model.lm_head</code>, <code>output</code>, <code>head</code>.</p>
</li>
</ul>
<p><strong>Returns:</strong> <code>InterpretableModel</code> instance</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterpretableModel</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># Load from model name (auto-detection works)</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="s2">&quot;mlx-community/Llama-3.2-1B-Instruct&quot;</span><span class="p">)</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="c1"># Wrap existing model</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="n">base_model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>  <span class="c1"># Your model</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">my_tokenizer</span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1"># Custom layer attribute</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">gpt2_model</span><span class="p">,</span> <span class="n">layer_attr</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="c1"># Custom model with non-standard attribute names</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="n">custom_model</span><span class="p">,</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="n">tokenizer</span><span class="o">=</span><span class="n">my_tokenizer</span><span class="p">,</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="n">embedding_path</span><span class="o">=</span><span class="s2">&quot;my_custom_embeddings&quot;</span><span class="p">,</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">norm_path</span><span class="o">=</span><span class="s2">&quot;my_final_norm&quot;</span><span class="p">,</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="n">lm_head_path</span><span class="o">=</span><span class="s2">&quot;my_output_projection&quot;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="method-trace">Method: <code>trace</code><a class="headerlink" href="#method-trace" title="Permanent link">&para;</a></h4>
<p>Create a tracing context for capturing activations and applying interventions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">interventions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Trace</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>inputs</strong>: Input data in various formats:</li>
<li><code>str</code>: Single text prompt (requires tokenizer)</li>
<li><code>List[str]</code>: Batch of text prompts (requires tokenizer)</li>
<li><code>mx.array</code>: Token array, shape <code>(batch, seq_len)</code></li>
<li>
<p><code>List[int]</code>: Single sequence of token IDs</p>
</li>
<li>
<p><strong>interventions</strong> (<code>Optional[Dict[str, Callable]]</code>): Dictionary mapping module names to intervention functions. Module names use dot notation (e.g., <code>"layers.3.self_attn"</code> for mlx-lm models).</p>
</li>
</ul>
<p><strong>Returns:</strong> <code>Trace</code> context manager</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Basic tracing</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">):</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1"># With interventions</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">interventions</span> <span class="k">as</span> <span class="n">iv</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)}):</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Batch inputs</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">([</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">]):</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">acts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h4 id="method-encode">Method: <code>encode</code><a class="headerlink" href="#method-encode" title="Permanent link">&para;</a></h4>
<p>Encode text to token IDs using the model's tokenizer.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>text</strong> (<code>str</code>): Text string to encode</li>
</ul>
<p><strong>Returns:</strong> List of token IDs</p>
<p><strong>Raises:</strong> <code>ValueError</code> if no tokenizer is available</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">tokens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>  <span class="c1"># [128000, 9906, 1917]</span>
</span></code></pre></div>
<hr />
<h4 id="method-decode">Method: <code>decode</code><a class="headerlink" href="#method-decode" title="Permanent link">&para;</a></h4>
<p>Decode token IDs to text using the model's tokenizer.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>tokens</strong> (<code>List[int]</code> or <code>mx.array</code>): Token IDs to decode</li>
</ul>
<p><strong>Returns:</strong> Decoded text string</p>
<p><strong>Raises:</strong> <code>ValueError</code> if no tokenizer is available</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">text</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">([</span><span class="mi">128000</span><span class="p">,</span> <span class="mi">9906</span><span class="p">,</span> <span class="mi">1917</span><span class="p">])</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># &quot;&lt;|begin_of_text|&gt;Hello world&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1"># Also works with mx.array</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mx</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">tokens_array</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">128000</span><span class="p">,</span> <span class="mi">9906</span><span class="p">,</span> <span class="mi">1917</span><span class="p">])</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">text</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tokens_array</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="method-encode_batch">Method: <code>encode_batch</code><a class="headerlink" href="#method-encode_batch" title="Permanent link">&para;</a></h4>
<p>Encode multiple texts to token IDs.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">model</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">(</span><span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>texts</strong> (<code>List[str]</code>): List of text strings to encode</li>
</ul>
<p><strong>Returns:</strong> List of token ID lists</p>
<p><strong>Raises:</strong> <code>ValueError</code> if no tokenizer is available</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">token_lists</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode_batch</span><span class="p">([</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">])</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">token_lists</span><span class="p">)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="c1"># [[128000, 9906], [128000, 10343], [128000, 2323]]</span>
</span></code></pre></div>
<hr />
<h4 id="method-token_to_str">Method: <code>token_to_str</code><a class="headerlink" href="#method-token_to_str" title="Permanent link">&para;</a></h4>
<p>Convert a single token ID to its string representation.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">model</span><span class="o">.</span><span class="n">token_to_str</span><span class="p">(</span><span class="n">token_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>token_id</strong> (<code>int</code>): Token ID to decode</li>
</ul>
<p><strong>Returns:</strong> String representation of the token</p>
<p><strong>Raises:</strong> <code>ValueError</code> if no tokenizer is available</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Decode individual tokens</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">tokens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">token_str</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">token_to_str</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">token_id</span><span class="si">}</span><span class="s2"> -&gt; &#39;</span><span class="si">{</span><span class="n">token_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="c1"># Output:</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="c1"># Token 0: 128000 -&gt; &#39;&lt;|begin_of_text|&gt;&#39;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="c1"># Token 1: 9906 -&gt; &#39;Hello&#39;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="c1"># Token 2: 1917 -&gt; &#39; world&#39;</span>
</span></code></pre></div>
<hr />
<h4 id="property-vocab_size">Property: <code>vocab_size</code><a class="headerlink" href="#property-vocab_size" title="Permanent link">&para;</a></h4>
<p>Get the vocabulary size of the tokenizer.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">model</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Returns:</strong> Vocabulary size, or <code>None</code> if no tokenizer is available</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary size: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">vocab_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 128000</span>
</span></code></pre></div>
<hr />
<h4 id="attribute-tokenizer">Attribute: <code>tokenizer</code><a class="headerlink" href="#attribute-tokenizer" title="Permanent link">&para;</a></h4>
<p>Direct access to the underlying tokenizer for advanced operations.</p>
<p><strong>Type:</strong> Tokenizer object (varies by model)</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Access tokenizer directly for advanced features</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># Use tokenizer-specific methods</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="s1">&#39;special_tokens&#39;</span><span class="p">):</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">special_tokens</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="method-get_token_predictions">Method: <code>get_token_predictions</code><a class="headerlink" href="#method-get_token_predictions" title="Permanent link">&para;</a></h4>
<p>Decode hidden states to token predictions using the model's output projection.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">model</span><span class="o">.</span><span class="n">get_token_predictions</span><span class="p">(</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="n">hidden_state</span><span class="p">:</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="n">return_scores</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">embedding_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">lm_head</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>hidden_state</strong> (<code>mx.array</code>): Hidden state tensor, shape <code>(hidden_dim,)</code> or <code>(batch, hidden_dim)</code></li>
<li><strong>top_k</strong> (<code>int</code>, default: <code>10</code>): Number of top predictions to return</li>
<li><strong>return_scores</strong> (<code>bool</code>, default: <code>False</code>): If True, return <code>(token_id, score)</code> tuples</li>
<li><strong>embedding_layer</strong> (<code>Optional[Any]</code>, default: <code>None</code>): Override embedding layer for weight-tied projection. If provided, uses this layer's weights for output projection.</li>
<li><strong>lm_head</strong> (<code>Optional[Any]</code>, default: <code>None</code>): Override lm_head layer. If provided, uses this layer directly. Takes precedence over <code>embedding_layer</code>.</li>
</ul>
<p><strong>Returns:</strong> List of token IDs or <code>(token_id, score)</code> tuples</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Get predictions from a specific layer</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;The capital of France is&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">trace</span><span class="p">:</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">layer_6</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;model.model.layers.6&quot;</span><span class="p">]</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c1"># Get last token&#39;s hidden state</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">last_token_hidden</span> <span class="o">=</span> <span class="n">layer_6</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="c1"># Get top predictions</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_token_predictions</span><span class="p">(</span><span class="n">last_token_hidden</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="c1"># Decode to words</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">token_to_str</span><span class="p">(</span><span class="n">token_id</span><span class="p">))</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="c1"># With scores</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="n">predictions_with_scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_token_predictions</span><span class="p">(</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>    <span class="n">last_token_hidden</span><span class="p">,</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>    <span class="n">return_scores</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="p">)</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="k">for</span> <span class="n">token_id</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">predictions_with_scores</span><span class="p">:</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="n">token_str</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">token_to_str</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="c1"># Custom model with override at call time</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_token_predictions</span><span class="p">(</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>    <span class="n">hidden</span><span class="p">,</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>    <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>    <span class="n">lm_head</span><span class="o">=</span><span class="n">custom_model</span><span class="o">.</span><span class="n">my_lm_head</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Notes:</strong>
- Automatically handles weight-tied models (uses embedding weights transposed)
- Works with quantized embeddings (dequantizes automatically)
- Model-agnostic: auto-detects embedding/lm_head paths for various architectures
- Useful for analyzing what any layer "thinks" at a specific position</p>
<hr />
<h4 id="method-logit_lens">Method: <code>logit_lens</code><a class="headerlink" href="#method-logit_lens" title="Permanent link">&para;</a></h4>
<p>Apply logit lens technique to see what each layer predicts at each token position.</p>
<p>The logit lens projects each layer's hidden states through the final layer norm and embedding matrix to see what tokens each layer predicts at each position in the input sequence.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="n">max_display_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="n">font_family</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">final_norm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">skip_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>text</strong> (<code>str</code>): Input text to analyze</li>
<li><strong>top_k</strong> (<code>int</code>, default: <code>1</code>): Number of top predictions to return per position</li>
<li><strong>layers</strong> (<code>Optional[List[int]]</code>, default: <code>None</code>): Specific layers to analyze (None = all)</li>
<li><strong>position</strong> (<code>Optional[int]</code>, default: <code>None</code>): Specific position to analyze (None = all). Supports negative indexing (-1 = last position).</li>
<li><strong>plot</strong> (<code>bool</code>, default: <code>False</code>): If True, display a heatmap visualization showing predictions</li>
<li><strong>max_display_tokens</strong> (<code>int</code>, default: <code>15</code>): Maximum number of tokens to show in visualization (from the end)</li>
<li><strong>figsize</strong> (<code>tuple</code>, default: <code>(16, 10)</code>): Figure size for plot (width, height)</li>
<li><strong>cmap</strong> (<code>str</code>, default: <code>'viridis'</code>): Colormap for heatmap</li>
<li><strong>font_family</strong> (<code>Optional[str]</code>, default: <code>None</code>): Font for plot (use 'Arial Unicode MS' for CJK support)</li>
<li><strong>final_norm</strong> (<code>Optional[Any]</code>, default: <code>None</code>): Override final layer normalization module. If provided, uses this module instead of auto-detected norm layer.</li>
<li><strong>skip_norm</strong> (<code>bool</code>, default: <code>False</code>): If True, skip final layer normalization entirely. Useful for models without a final norm layer.</li>
</ul>
<p><strong>Returns:</strong> Dict mapping <code>layer_idx</code> -&gt; list of positions -&gt; list of <code>(token_id, score, token_str)</code> tuples</p>
<p><strong>Structure:</strong> <code>{layer_idx: [[pos_0_predictions], [pos_1_predictions], ...]}</code></p>
<p><strong>Model Compatibility:</strong> This method automatically detects model structure and works with:
- mlx-lm models (<code>model.model.norm</code>, <code>model.model.embed_tokens</code>)
- GPT-2 style models (<code>ln_f</code>, <code>wte</code>)
- Custom models (use <code>norm_path</code> constructor arg or <code>final_norm</code>/<code>skip_norm</code> parameters)</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Get predictions at all positions for all layers</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span><span class="s2">&quot;The capital of France is&quot;</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1"># Access predictions for layer 10 at position 3</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">layer_10_predictions</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">pos_3_top_pred</span> <span class="o">=</span> <span class="n">layer_10_predictions</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># (token_id, score, token_str)</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer 10, Position 3: </span><span class="si">{</span><span class="n">pos_3_top_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="c1"># Show what each layer predicts at the LAST position</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The capital of France is&quot;</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">]:</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    <span class="c1"># Get prediction at last position</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    <span class="n">last_pos_pred</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">layer_idx</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="n">last_pos_pred</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="c1"># Output:</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="c1"># Layer  0: &#39; the&#39;</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="c1"># Layer  5: &#39; a&#39;</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="c1"># Layer 10: &#39; Paris&#39;</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="c1"># Layer 15: &#39; Paris&#39;</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># Show predictions at each position for a specific layer</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;The capital of France&quot;</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="n">tokens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="k">for</span> <span class="n">pos_idx</span><span class="p">,</span> <span class="n">predictions</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">10</span><span class="p">]):</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>    <span class="n">input_token</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">token_to_str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">pos_idx</span><span class="p">])</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>    <span class="n">pred_token</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Top prediction</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position </span><span class="si">{</span><span class="n">pos_idx</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">input_token</span><span class="si">}</span><span class="s2">&#39;) -&gt; &#39;</span><span class="si">{</span><span class="n">pred_token</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="c1"># Visualize with heatmap</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>    <span class="s2">&quot;The Eiffel Tower is located in the city of&quot;</span><span class="p">,</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>    <span class="n">max_display_tokens</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="p">)</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a><span class="c1"># Displays a heatmap with:</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="c1">#   - X-axis: Input token positions</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="c1">#   - Y-axis: Model layers</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a><span class="c1">#   - Cell values: Top predicted token at each (layer, position)</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a><span class="c1">#   - Colors: Different predictions shown with different colors</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a><span class="c1"># Model without final normalization</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">,</span> <span class="n">skip_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a><span class="c1"># Custom final norm at call time</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>    <span class="s2">&quot;Hello world&quot;</span><span class="p">,</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>    <span class="n">final_norm</span><span class="o">=</span><span class="n">custom_model</span><span class="o">.</span><span class="n">my_final_norm</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Note:</strong> Plotting requires matplotlib: <code>pip install matplotlib</code></p>
<p><strong>Use Cases:</strong>
- Understand how model predictions evolve through layers
- Debug model behavior at intermediate layers
- Visualize progressive refinement of predictions
- Identify where in the model certain facts are computed</p>
<hr />
<h4 id="method-tuned_lens">Method: <code>tuned_lens</code><a class="headerlink" href="#method-tuned_lens" title="Permanent link">&para;</a></h4>
<p>Apply tuned lens for improved layer-wise predictions.</p>
<p>The tuned lens technique (Belrose et al., 2023) uses learned affine transformations for each layer to correct for coordinate system mismatches between layers, producing more accurate intermediate predictions than the standard logit lens.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">model</span><span class="o">.</span><span class="n">tuned_lens</span><span class="p">(</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="n">tuned_lens</span><span class="p">:</span> <span class="n">TunedLens</span><span class="p">,</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="n">position</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="n">max_display_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>    <span class="n">font_family</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="n">final_norm</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="n">skip_norm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]]]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>text</strong> (<code>str</code>): Input text to analyze</li>
<li><strong>tuned_lens</strong> (<code>TunedLens</code>): Trained TunedLens instance with layer translators</li>
<li><strong>top_k</strong> (<code>int</code>, default: <code>1</code>): Number of top predictions to return per position</li>
<li><strong>layers</strong> (<code>Optional[List[int]]</code>, default: <code>None</code>): Specific layers to analyze (None = all)</li>
<li><strong>position</strong> (<code>Optional[int]</code>, default: <code>None</code>): Specific position to analyze (None = all). Supports negative indexing.</li>
<li><strong>plot</strong> (<code>bool</code>, default: <code>False</code>): If True, display a heatmap visualization</li>
<li><strong>max_display_tokens</strong> (<code>int</code>, default: <code>15</code>): Maximum number of tokens to show in visualization</li>
<li><strong>figsize</strong> (<code>tuple</code>, default: <code>(16, 10)</code>): Figure size for plot</li>
<li><strong>cmap</strong> (<code>str</code>, default: <code>'viridis'</code>): Colormap for heatmap</li>
<li><strong>font_family</strong> (<code>Optional[str]</code>): Font for plot (auto-detected if None)</li>
<li><strong>final_norm</strong> (<code>Any</code>, default: <code>None</code>): Override for final layer norm. Pass a callable to use a custom norm.</li>
<li><strong>skip_norm</strong> (<code>bool</code>, default: <code>False</code>): If True, skip final layer normalization (for models without it)</li>
</ul>
<p><strong>Returns:</strong> Dict mapping <code>layer_idx</code> -&gt; list of positions -&gt; list of <code>(token_id, score, token_str)</code> tuples</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterpretableModel</span><span class="p">,</span> <span class="n">TunedLens</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="s2">&quot;mlx-community/Llama-3.2-1B-Instruct&quot;</span><span class="p">)</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1"># Option 1: Train new tuned lens</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_tuned_lens</span><span class="p">(</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="n">dataset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Sample text 1&quot;</span><span class="p">,</span> <span class="s2">&quot;Sample text 2&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="n">num_steps</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;tuned_lens_llama.npz&quot;</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="p">)</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="c1"># Option 2: Load pre-trained tuned lens</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_tuned_lens</span><span class="p">(</span><span class="s2">&quot;tuned_lens_llama.npz&quot;</span><span class="p">)</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="c1"># Apply tuned lens</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tuned_lens</span><span class="p">(</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="s2">&quot;The capital of France is&quot;</span><span class="p">,</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>    <span class="n">tuned_lens</span><span class="p">,</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="p">)</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="c1"># Compare with regular logit lens</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="n">regular_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">logit_lens</span><span class="p">(</span><span class="s2">&quot;The capital of France is&quot;</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
</span></code></pre></div>
<p><strong>Reference:</strong> Belrose et al., "Eliciting Latent Predictions from Transformers with the Tuned Lens" (https://arxiv.org/abs/2303.08112)</p>
<hr />
<h4 id="method-train_tuned_lens">Method: <code>train_tuned_lens</code><a class="headerlink" href="#method-train_tuned_lens" title="Permanent link">&para;</a></h4>
<p>Train a tuned lens for this model.</p>
<p>The tuned lens technique trains small affine transformations for each layer to correct for coordinate system mismatches, producing more accurate intermediate predictions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">model</span><span class="o">.</span><span class="n">train_tuned_lens</span><span class="p">(</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    <span class="n">dataset</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">momentum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">gradient_clip</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>    <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TunedLens</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>dataset</strong> (<code>List[str]</code>): List of text strings for training</li>
<li><strong>num_steps</strong> (<code>int</code>, default: <code>250</code>): Number of training steps</li>
<li><strong>learning_rate</strong> (<code>float</code>, default: <code>1.0</code>): Initial learning rate (uses linear decay)</li>
<li><strong>momentum</strong> (<code>float</code>, default: <code>0.9</code>): Nesterov momentum coefficient</li>
<li><strong>max_seq_len</strong> (<code>int</code>, default: <code>2048</code>): Maximum sequence length for training chunks</li>
<li><strong>gradient_clip</strong> (<code>float</code>, default: <code>1.0</code>): Gradient clipping norm</li>
<li><strong>save_path</strong> (<code>Optional[str]</code>): Path to save trained weights</li>
<li><strong>verbose</strong> (<code>bool</code>, default: <code>True</code>): Print training progress</li>
<li><strong>callback</strong> (<code>Optional[Callable]</code>): Callback function called with <code>(step, loss)</code> after each step</li>
</ul>
<p><strong>Returns:</strong> Trained <code>TunedLens</code> instance</p>
<p><strong>Raises:</strong></p>
<ul>
<li><code>ValueError</code>: If dataset is empty or contains only whitespace</li>
<li><code>ValueError</code>: If dataset has fewer tokens than <code>max_seq_len</code></li>
<li><code>ValueError</code>: If <code>max_seq_len</code> is less than 10 tokens</li>
<li><code>ValueError</code>: If model hidden dimension cannot be determined</li>
</ul>
<p><strong>Training Details (from paper):</strong>
- Optimizer: SGD with Nesterov momentum (0.9)
- Learning rate: 1.0 with linear decay over training steps
- Gradient clipping: norm 1.0
- Loss: KL divergence between translator prediction and final output</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Load sample texts for training</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="s2">&quot;The capital of France is Paris.&quot;</span><span class="p">,</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="s2">&quot;Machine learning is a subset of artificial intelligence.&quot;</span><span class="p">,</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="c1"># ... more training texts</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="p">]</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="c1"># Train tuned lens</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train_tuned_lens</span><span class="p">(</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="n">dataset</span><span class="o">=</span><span class="n">texts</span><span class="p">,</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="n">num_steps</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;my_tuned_lens.npz&quot;</span><span class="p">,</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="method-load_tuned_lens">Method: <code>load_tuned_lens</code><a class="headerlink" href="#method-load_tuned_lens" title="Permanent link">&para;</a></h4>
<p>Load a pre-trained tuned lens from a file.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">model</span><span class="o">.</span><span class="n">load_tuned_lens</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TunedLens</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>path</strong> (<code>str</code>): Path to the saved tuned lens weights (expects <code>.npz</code> and <code>.json</code> files)</li>
</ul>
<p><strong>Returns:</strong> Loaded <code>TunedLens</code> instance</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">load_tuned_lens</span><span class="p">(</span><span class="s2">&quot;tuned_lens_llama.npz&quot;</span><span class="p">)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tuned_lens</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">,</span> <span class="n">tuned_lens</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="method-activation_patching">Method: <code>activation_patching</code><a class="headerlink" href="#method-activation_patching" title="Permanent link">&para;</a></h4>
<p>Automated activation patching to identify important layers for a task.</p>
<p>This helper method performs activation patching across all (or specified) layers to determine which components are critical for a specific task. It automates the boilerplate of running clean/corrupted inputs, patching activations, and measuring recovery.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="n">clean_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="n">corrupted_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">component</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mlp&quot;</span><span class="p">,</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;RdBu_r&quot;</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>clean_text</strong> (<code>str</code>): Clean/correct input text</li>
<li><strong>corrupted_text</strong> (<code>str</code>): Corrupted input text (differs in the aspect you're studying)</li>
<li><strong>component</strong> (<code>str</code>, default: <code>"mlp"</code>): Component to patch. Options:</li>
<li><code>"mlp"</code> - Full MLP block</li>
<li><code>"self_attn"</code> - Full attention block</li>
<li><code>"mlp.gate_proj"</code> - MLP gate projection</li>
<li><code>"mlp.up_proj"</code> - MLP up projection</li>
<li><code>"mlp.down_proj"</code> - MLP down projection</li>
<li><code>"self_attn.q_proj"</code> - Query projection</li>
<li><code>"self_attn.k_proj"</code> - Key projection</li>
<li><code>"self_attn.v_proj"</code> - Value projection</li>
<li><code>"self_attn.o_proj"</code> - Output projection</li>
<li><strong>layers</strong> (<code>Optional[List[int]]</code>, default: <code>None</code>): Specific layers to test (None = all layers)</li>
<li><strong>metric</strong> (<code>str</code>, default: <code>"l2"</code>): Distance metric. Options:</li>
<li><code>"l2"</code>: Euclidean distance (default, with overflow protection)</li>
<li><code>"cosine"</code>: Cosine distance (recommended for large vocabularies)</li>
<li><code>"mse"</code>: Mean squared error (most stable for huge models &gt; 100k vocab)</li>
</ul>
<p><strong>Recommendation</strong>:
  - Vocab &lt; 50k: use <code>"l2"</code>
  - Vocab 50k-100k: use <code>"l2"</code> or <code>"cosine"</code>
  - Vocab &gt; 100k: use <code>"mse"</code> or <code>"cosine"</code>
- <strong>plot</strong> (<code>bool</code>, default: <code>False</code>): If True, display a bar chart of recovery percentages
- <strong>figsize</strong> (<code>tuple</code>, default: <code>(12, 8)</code>): Figure size for plot
- <strong>cmap</strong> (<code>str</code>, default: <code>"RdBu_r"</code>): Colormap for plot (blue = positive, red = negative)</p>
<p><strong>Returns:</strong> Dict mapping <code>layer_idx</code> -&gt; recovery percentage</p>
<p><strong>Recovery Interpretation:</strong>
- <strong>Positive %</strong> (e.g., +40%): Layer is important for the task
- <strong>Negative %</strong> (e.g., -20%): Layer encodes the corruption
- <strong>~0%</strong>: Layer is not relevant to this task</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Find which MLP layers are important for factual recall</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">clean_text</span><span class="o">=</span><span class="s2">&quot;Paris is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="n">corrupted_text</span><span class="o">=</span><span class="s2">&quot;London is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="p">)</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="c1"># Analyze results</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="n">sorted_results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most important layers:&quot;</span><span class="p">)</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="k">for</span> <span class="n">layer_idx</span><span class="p">,</span> <span class="n">recovery</span> <span class="ow">in</span> <span class="n">sorted_results</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Layer </span><span class="si">{</span><span class="n">layer_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">recovery</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% recovery&quot;</span><span class="p">)</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># Output:</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="c1"># Layer  0: +43.1% recovery   Very important!</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="c1"># Layer 15: +24.2% recovery   Important</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="c1"># Layer  6: +17.6% recovery   Somewhat important</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="c1"># Test specific layers only</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>    <span class="n">clean_text</span><span class="o">=</span><span class="s2">&quot;Paris is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="n">corrupted_text</span><span class="o">=</span><span class="s2">&quot;London is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;self_attn&quot;</span><span class="p">,</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="p">)</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="c1"># Test MLP sub-components</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>    <span class="n">clean_text</span><span class="o">=</span><span class="s2">&quot;The cat sits on the mat&quot;</span><span class="p">,</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>    <span class="n">corrupted_text</span><span class="o">=</span><span class="s2">&quot;The cat sit on the mat&quot;</span><span class="p">,</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;mlp.gate_proj&quot;</span><span class="p">,</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="p">)</span>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="c1"># For large vocabulary models (&gt; 100k tokens), use MSE metric</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>    <span class="n">clean_text</span><span class="o">=</span><span class="s2">&quot;Paris is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>    <span class="n">corrupted_text</span><span class="o">=</span><span class="s2">&quot;London is the capital of France&quot;</span><span class="p">,</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>    <span class="n">component</span><span class="o">=</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>    <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span>  <span class="c1"># Most stable for Qwen, GPT-4 scale models</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Note:</strong> Plotting requires matplotlib: <code>pip install matplotlib</code></p>
<p><strong>Distance Metrics</strong>:</p>
<p>The method supports three distance metrics for measuring output differences:</p>
<ol>
<li>
<p><strong>L2 (Euclidean)</strong> - Default, best for models with &lt; 50k vocab
   <div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>d(a,b) = ((a-b))
</span></code></pre></div></p>
</li>
<li>
<p><strong>Cosine</strong> - Best for direction-based similarity, good for 50k-150k vocab
   <div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>d(a,b) = 1 - (ab)/(||a||||b||)
</span></code></pre></div></p>
</li>
<li>
<p><strong>MSE (Mean Squared Error)</strong> - Most stable for very large models (&gt; 100k vocab)
   <div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>d(a,b) = (1/N)(a-b)
</span></code></pre></div></p>
</li>
</ol>
<p><strong>Example with large vocabulary model</strong> (Qwen: 151k tokens):
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># Without correct metric - gets NaN</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;l2&quot;</span><span class="p">)</span>  <span class="c1">#  May overflow</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="c1"># With correct metric - works perfectly</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">activation_patching</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">)</span>  <span class="c1">#  Stable</span>
</span></code></pre></div></p>
<p><strong>See Also:</strong> <a href="../guides/activation_patching/">Activation Patching Guide</a> for comprehensive coverage including metric selection and numerical details</p>
<hr />
<h4 id="method-named_modules">Method: <code>named_modules</code><a class="headerlink" href="#method-named_modules" title="Permanent link">&para;</a></h4>
<p>Iterator over all modules in the wrapped model with their names.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]]</span>
</span></code></pre></div>
<p><strong>Returns:</strong> Iterator yielding <code>(name, module)</code> tuples</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="attribute-layers">Attribute: <code>layers</code><a class="headerlink" href="#attribute-layers" title="Permanent link">&para;</a></h4>
<p>Indexed access to model layers via <code>LayerListProxy</code>.</p>
<p><strong>Type:</strong> <code>LayerListProxy</code></p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="c1"># Access specific layer</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="n">layer_3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="c1"># Iterate over layers</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="c1"># Get number of layers</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="n">num_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h4 id="attribute-output">Attribute: <code>output</code><a class="headerlink" href="#attribute-output" title="Permanent link">&para;</a></h4>
<p>Access to model output within a trace context. Returns an <code>OutputProxy</code> that can be saved.</p>
<p><strong>Type:</strong> <code>OutputProxy</code></p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">input_text</span><span class="p">):</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>    <span class="n">final_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h2 id="tracing">Tracing<a class="headerlink" href="#tracing" title="Permanent link">&para;</a></h2>
<h3 id="class-trace">Class: <code>Trace</code><a class="headerlink" href="#class-trace" title="Permanent link">&para;</a></h3>
<p>Context manager for tracing model execution. Created by <code>InterpretableModel.trace()</code>.</p>
<h4 id="attributes">Attributes<a class="headerlink" href="#attributes" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>output</strong> (<code>mx.array</code>): Model output after trace completes</li>
<li><strong>saved_values</strong> (<code>Dict[str, mx.array]</code>): Values saved with <code>.save()</code></li>
<li><strong>activations</strong> (<code>Dict[str, mx.array]</code>): All captured activations by module name</li>
</ul>
<h4 id="methods">Methods<a class="headerlink" href="#methods" title="Permanent link">&para;</a></h4>
<h5 id="getname-str-optionalmxarray"><code>get(name: str) -&gt; Optional[mx.array]</code><a class="headerlink" href="#getname-str-optionalmxarray" title="Permanent link">&para;</a></h5>
<p>Get a saved value by name.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">as</span> <span class="n">trace</span><span class="p">:</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>    <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="n">activation</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layers.3.output&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h5 id="get_activationname-str-optionalmxarray"><code>get_activation(name: str) -&gt; Optional[mx.array]</code><a class="headerlink" href="#get_activationname-str-optionalmxarray" title="Permanent link">&para;</a></h5>
<p>Get an activation by module name.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">as</span> <span class="n">trace</span><span class="p">:</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>    <span class="k">pass</span>  <span class="c1"># Activations captured automatically</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="c1"># Note: get_activation requires the full key (not normalized)</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="n">attn_act</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_activation</span><span class="p">(</span><span class="s2">&quot;model.model.layers.3.self_attn&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="class-outputproxy">Class: <code>OutputProxy</code><a class="headerlink" href="#class-outputproxy" title="Permanent link">&para;</a></h3>
<p>Wraps module outputs to provide <code>.save()</code> functionality.</p>
<h4 id="method-save-any">Method: <code>save() -&gt; Any</code><a class="headerlink" href="#method-save-any" title="Permanent link">&para;</a></h4>
<p>Save the wrapped value to the current trace context and return the unwrapped value.</p>
<p><strong>Returns:</strong> The underlying value (usually <code>mx.array</code>)</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>    <span class="c1"># Save returns the actual array (use self_attn for mlx-lm models)</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    <span class="n">attn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">self_attn</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># Can use immediately</span>
</span></code></pre></div>
<hr />
<h2 id="interventions">Interventions<a class="headerlink" href="#interventions" title="Permanent link">&para;</a></h2>
<p>Intervention functions modify activations during forward passes.</p>
<h3 id="module-mlxterpinterventions">Module: <code>mlxterp.interventions</code><a class="headerlink" href="#module-mlxterpinterventions" title="Permanent link">&para;</a></h3>
<p>Namespace containing pre-built intervention functions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">interventions</span> <span class="k">as</span> <span class="n">iv</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="c1"># Use intervention functions</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)}):</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-zero_out">Function: <code>zero_out</code><a class="headerlink" href="#function-zero_out" title="Permanent link">&para;</a></h3>
<p>Set activations to zero.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">zero_out</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span>
</span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.4&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">zero_out</span><span class="p">}):</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-scale">Function: <code>scale</code><a class="headerlink" href="#function-scale" title="Permanent link">&para;</a></h3>
<p>Multiply activations by a constant factor.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">scale</span><span class="p">(</span><span class="n">factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong>
- <strong>factor</strong> (<code>float</code>): Scaling factor</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1"># Reduce by 50%</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)}):</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="c1"># Amplify</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)}):</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-add_vector">Function: <code>add_vector</code><a class="headerlink" href="#function-add_vector" title="Permanent link">&para;</a></h3>
<p>Add a steering vector to activations.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">add_vector</span><span class="p">(</span><span class="n">vector</span><span class="p">:</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong>
- <strong>vector</strong> (<code>mx.array</code>): Vector to add (must be broadcastable to activation shape)</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mx</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="c1"># Create steering vector</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="n">steering</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((</span><span class="n">hidden_dim</span><span class="p">,))</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.5&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">add_vector</span><span class="p">(</span><span class="n">steering</span><span class="p">)}):</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>    <span class="n">steered_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-replace_with">Function: <code>replace_with</code><a class="headerlink" href="#function-replace_with" title="Permanent link">&para;</a></h3>
<p>Replace activations with a fixed value.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">replace_with</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong>
- <strong>value</strong>: Replacement value (array or scalar)</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># Replace with zeros</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">replace_with</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)}):</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="c1"># Replace with custom array</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="n">custom</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">batch</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">))</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">replace_with</span><span class="p">(</span><span class="n">custom</span><span class="p">)}):</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-clamp">Function: <code>clamp</code><a class="headerlink" href="#function-clamp" title="Permanent link">&para;</a></h3>
<p>Clamp activation values to a range.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">clamp</span><span class="p">(</span><span class="n">min_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong>
- <strong>min_val</strong> (<code>Optional[float]</code>): Minimum value
- <strong>max_val</strong> (<code>Optional[float]</code>): Maximum value</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># Clamp to [-1, 1]</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}):</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="c1"># Only maximum</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">max_val</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)}):</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="function-noise">Function: <code>noise</code><a class="headerlink" href="#function-noise" title="Permanent link">&para;</a></h3>
<p>Add Gaussian noise to activations.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">noise</span><span class="p">(</span><span class="n">std</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong>
- <strong>std</strong> (<code>float</code>, default: <code>0.1</code>): Standard deviation of noise</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">iv</span><span class="o">.</span><span class="n">noise</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)}):</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="class-interventioncomposer">Class: <code>InterventionComposer</code><a class="headerlink" href="#class-interventioncomposer" title="Permanent link">&para;</a></h3>
<p>Compose multiple interventions into a single function.</p>
<h4 id="method-add">Method: <code>add</code><a class="headerlink" href="#method-add" title="Permanent link">&para;</a></h4>
<p>Add an intervention to the composition.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">add</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">InterventionComposer</span>
</span></code></pre></div>
<p><strong>Returns:</strong> <code>self</code> for chaining</p>
<h4 id="method-build">Method: <code>build</code><a class="headerlink" href="#method-build" title="Permanent link">&para;</a></h4>
<p>Build the composed intervention function.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Returns:</strong> Composed intervention function</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">interventions</span> <span class="k">as</span> <span class="n">iv</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="c1"># Compose multiple interventions</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="n">combined</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">compose</span><span class="p">()</span> \
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iv</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mf">0.8</span><span class="p">))</span> \
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iv</span><span class="o">.</span><span class="n">noise</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span> \
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">iv</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span> \
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">combined</span><span class="p">}):</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="custom-interventions">Custom Interventions<a class="headerlink" href="#custom-interventions" title="Permanent link">&para;</a></h3>
<p>Create your own intervention functions:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mx</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">my_intervention</span><span class="p">(</span><span class="n">activation</span><span class="p">:</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom activation modification&quot;&quot;&quot;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>    <span class="c1"># Your logic here</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>    <span class="k">return</span> <span class="n">mx</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">interventions</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;layers.3&quot;</span><span class="p">:</span> <span class="n">my_intervention</span><span class="p">}):</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<p><strong>Requirements:</strong>
- Function signature: <code>(mx.array) -&gt; mx.array</code>
- Must return array with same shape as input
- Can use any MLX operations</p>
<hr />
<h2 id="utilities">Utilities<a class="headerlink" href="#utilities" title="Permanent link">&para;</a></h2>
<h3 id="function-get_activations">Function: <code>get_activations</code><a class="headerlink" href="#function-get_activations" title="Permanent link">&para;</a></h3>
<p>Collect activations for specified layers and token positions.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">get_activations</span><span class="p">(</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">InterpretableModel</span><span class="p">,</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>    <span class="n">prompts</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="n">positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>model</strong>: InterpretableModel instance</li>
<li><strong>prompts</strong>: Single prompt or list of prompts</li>
<li><strong>layers</strong>: Layer indices to collect (None = all layers)</li>
<li><strong>positions</strong>: Token position(s) to extract</li>
<li><code>-1</code>: Last token</li>
<li><code>0</code>: First token</li>
<li><code>[0, -1]</code>: First and last tokens</li>
</ul>
<p><strong>Returns:</strong> Dict mapping <code>"layer_{i}"</code> to activation arrays</p>
<p><strong>Shapes:</strong>
- Single position: <code>(batch_size, hidden_dim)</code>
- Multiple positions: <code>(batch_size, num_positions, hidden_dim)</code></p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_activations</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="c1"># Single prompt, multiple layers</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">get_activations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;Hello world&quot;</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="s2">&quot;layer_3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (1, hidden_dim)</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="c1"># Batch prompts</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">get_activations</span><span class="p">(</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>    <span class="p">[</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">],</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>    <span class="n">positions</span><span class="o">=-</span><span class="mi">1</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a><span class="p">)</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a><span class="nb">print</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="s2">&quot;layer_5&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (3, hidden_dim)</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a><span class="c1"># Multiple positions</span>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">get_activations</span><span class="p">(</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a>    <span class="s2">&quot;Test prompt&quot;</span><span class="p">,</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a>    <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># First and last token</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="p">)</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="nb">print</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="s2">&quot;layer_3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (1, 2, hidden_dim)</span>
</span></code></pre></div>
<hr />
<h3 id="function-batch_get_activations">Function: <code>batch_get_activations</code><a class="headerlink" href="#function-batch_get_activations" title="Permanent link">&para;</a></h3>
<p>Memory-efficient batch processing for large datasets.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">batch_get_activations</span><span class="p">(</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">InterpretableModel</span><span class="p">,</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>    <span class="n">prompts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="n">positions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>model</strong>: InterpretableModel instance</li>
<li><strong>prompts</strong>: List of prompts</li>
<li><strong>layers</strong>: Layer indices to collect</li>
<li><strong>positions</strong>: Token position(s) to extract</li>
<li><strong>batch_size</strong>: Number of prompts per batch</li>
</ul>
<p><strong>Returns:</strong> Dict mapping <code>"layer_{i}"</code> to concatenated activation arrays</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">batch_get_activations</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="c1"># Process 1000 prompts efficiently</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="n">large_dataset</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Prompt </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">batch_get_activations</span><span class="p">(</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>    <span class="n">prompts</span><span class="o">=</span><span class="n">large_dataset</span><span class="p">,</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="p">)</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a><span class="nb">print</span><span class="p">(</span><span class="n">acts</span><span class="p">[</span><span class="s2">&quot;layer_3&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (1000, hidden_dim)</span>
</span></code></pre></div>
<hr />
<h3 id="function-collect_activations">Function: <code>collect_activations</code><a class="headerlink" href="#function-collect_activations" title="Permanent link">&para;</a></h3>
<p>Direct activation collection with caching.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">collect_activations</span><span class="p">(</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">InterpretableModel</span><span class="p">,</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>    <span class="n">inputs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>    <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ActivationCache</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>model</strong>: InterpretableModel instance</li>
<li><strong>inputs</strong>: Input data</li>
<li><strong>layers</strong>: List of layer names to cache (None = all)</li>
</ul>
<p><strong>Returns:</strong> <code>ActivationCache</code> object</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect_activations</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="n">cache</span> <span class="o">=</span> <span class="n">collect_activations</span><span class="p">(</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="s2">&quot;Test input&quot;</span><span class="p">,</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layers.3&quot;</span><span class="p">,</span> <span class="s2">&quot;layers.8&quot;</span><span class="p">]</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="p">)</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="c1"># Access cached activations</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="n">act_3</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layers.3&quot;</span><span class="p">)</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cached </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span><span class="si">}</span><span class="s2"> activations&quot;</span><span class="p">)</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available keys: </span><span class="si">{</span><span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="core-components">Core Components<a class="headerlink" href="#core-components" title="Permanent link">&para;</a></h2>
<p>Advanced usage: Direct access to core components.</p>
<h3 id="class-moduleproxy">Class: <code>ModuleProxy</code><a class="headerlink" href="#class-moduleproxy" title="Permanent link">&para;</a></h3>
<p>Wraps <code>nn.Module</code> to intercept forward passes. Created automatically by <code>InterpretableModel</code>.</p>
<p><strong>Attributes:</strong>
- <code>output</code>: OutputProxy for the module's output</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1"># Access through InterpretableModel.layers</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="n">proxy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Returns ModuleProxy</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">proxy</span><span class="p">))</span>  <span class="c1"># ModuleProxy</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">act</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h3 id="class-layerlistproxy">Class: <code>LayerListProxy</code><a class="headerlink" href="#class-layerlistproxy" title="Permanent link">&para;</a></h3>
<p>Provides indexed access to model layers.</p>
<p><strong>Methods:</strong>
- <code>__getitem__(idx)</code>: Get layer at index
- <code>__len__()</code>: Number of layers
- <code>__iter__()</code>: Iterate over layers</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Created automatically</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="n">layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="c1"># Access</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="n">layer_3</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="c1"># Length</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">))</span>  <span class="c1"># 12</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="c1"># Iterate</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="class-activationcache">Class: <code>ActivationCache</code><a class="headerlink" href="#class-activationcache" title="Permanent link">&para;</a></h3>
<p>Storage for cached activations.</p>
<p><strong>Attributes:</strong>
- <strong>activations</strong> (<code>Dict[str, mx.array]</code>): Activation storage
- <strong>metadata</strong> (<code>Optional[Dict]</code>): Additional information</p>
<p><strong>Methods:</strong>
- <code>get(name)</code>: Get activation by name
- <code>keys()</code>: List all cached names
- <code>__contains__(name)</code>: Check if activation exists
- <code>__len__()</code>: Number of cached activations</p>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">collect_activations</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">cache</span> <span class="o">=</span> <span class="n">collect_activations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="c1"># Access</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="n">act</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layers.3&quot;</span><span class="p">)</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="c1"># Check existence</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="k">if</span> <span class="s2">&quot;layers.3&quot;</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found!&quot;</span><span class="p">)</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="c1"># List all</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h3 id="class-moduleresolver">Class: <code>ModuleResolver</code><a class="headerlink" href="#class-moduleresolver" title="Permanent link">&para;</a></h3>
<p>Generic module resolution for different MLX model architectures. Automatically finds embedding, final norm, and lm_head modules using fallback chains.</p>
<p><strong>Constructor:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">ModuleResolver</span><span class="p">(</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="n">embedding_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="n">norm_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    <span class="n">lm_head_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="p">)</span>
</span></code></pre></div>
<p><strong>Methods:</strong></p>
<ul>
<li><code>get_embedding_layer()</code>: Get token embedding layer</li>
<li><code>get_final_norm()</code>: Get final layer normalization</li>
<li><code>get_lm_head()</code>: Get output projection layer</li>
<li><code>get_output_projection()</code>: Get output projection with weight-tied detection. Returns <code>(module, path, is_weight_tied)</code></li>
<li><code>clear_cache()</code>: Clear resolved module cache (call after modifying model structure)</li>
</ul>
<p><strong>Fallback Chains:</strong></p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Resolution Order</th>
</tr>
</thead>
<tbody>
<tr>
<td>Embedding</td>
<td><code>model.embed_tokens</code>, <code>model.model.embed_tokens</code>, <code>embed_tokens</code>, <code>tok_embeddings</code>, <code>wte</code></td>
</tr>
<tr>
<td>Final Norm</td>
<td><code>model.norm</code>, <code>model.model.norm</code>, <code>norm</code>, <code>ln_f</code>, <code>model.ln_f</code></td>
</tr>
<tr>
<td>LM Head</td>
<td><code>lm_head</code>, <code>model.lm_head</code>, <code>model.model.lm_head</code>, <code>output</code>, <code>head</code> (falls back to embedding if not found)</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModuleResolver</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="c1"># Create resolver for a model</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="n">resolver</span> <span class="o">=</span> <span class="n">ModuleResolver</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="c1"># Get components</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="n">embedding</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">get_embedding_layer</span><span class="p">()</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="n">norm</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">get_final_norm</span><span class="p">()</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="n">proj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">is_tied</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">get_output_projection</span><span class="p">()</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="k">if</span> <span class="n">is_tied</span><span class="p">:</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model uses weight-tied embedding for output&quot;</span><span class="p">)</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="c1"># With custom paths</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="n">resolver</span> <span class="o">=</span> <span class="n">ModuleResolver</span><span class="p">(</span>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>    <span class="n">embedding_path</span><span class="o">=</span><span class="s2">&quot;my_embed&quot;</span><span class="p">,</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>    <span class="n">norm_path</span><span class="o">=</span><span class="s2">&quot;my_norm&quot;</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="p">)</span>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>
</span><span id="__span-65-21"><a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a><span class="c1"># Cache invalidation (after modifying model structure)</span>
</span><span id="__span-65-22"><a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a><span class="n">resolver</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>  <span class="c1"># Force re-resolution on next access</span>
</span></code></pre></div>
<hr />
<h3 id="class-tunedlens">Class: <code>TunedLens</code><a class="headerlink" href="#class-tunedlens" title="Permanent link">&para;</a></h3>
<p>Learned affine translators for each layer, implementing the Tuned Lens technique from Belrose et al. (2023).</p>
<p>The tuned lens uses layer-specific affine transformations (Wx + b) to map hidden states from each layer into a space where the final output projection can make accurate predictions. This corrects for coordinate system mismatches between layers.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">TunedLens</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">TunedLens</span><span class="p">(</span><span class="n">num_layers</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li><strong>num_layers</strong> (<code>int</code>): Number of transformer layers in the model</li>
<li><strong>hidden_dim</strong> (<code>int</code>): Dimension of hidden states</li>
</ul>
<p><strong>Attributes:</strong></p>
<ul>
<li><code>num_layers</code>: Number of layers</li>
<li><code>hidden_dim</code>: Hidden dimension</li>
<li><code>translators</code>: List of linear layers, one per transformer layer</li>
</ul>
<p><strong>Methods:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__call__(h, layer_idx)</code></td>
<td>Apply translator for a specific layer</td>
</tr>
<tr>
<td><code>save(path)</code></td>
<td>Save weights and config to files (.npz and .json)</td>
</tr>
<tr>
<td><code>load(path)</code></td>
<td>Load tuned lens from saved files (classmethod)</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">TunedLens</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="c1"># Create tuned lens</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="n">tuned_lens</span> <span class="o">=</span> <span class="n">TunedLens</span><span class="p">(</span><span class="n">num_layers</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">4096</span><span class="p">)</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="c1"># Apply to hidden state from layer 10</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a><span class="n">translated</span> <span class="o">=</span> <span class="n">tuned_lens</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">,</span> <span class="n">layer_idx</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a><span class="c1"># Save and load</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a><span class="n">tuned_lens</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;my_tuned_lens&quot;</span><span class="p">)</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="n">loaded</span> <span class="o">=</span> <span class="n">TunedLens</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;my_tuned_lens&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Reference:</strong> Belrose et al., "Eliciting Latent Predictions from Transformers with the Tuned Lens" (https://arxiv.org/abs/2303.08112)</p>
<hr />
<h3 id="function-normalize_layer_key">Function: <code>normalize_layer_key</code><a class="headerlink" href="#function-normalize_layer_key" title="Permanent link">&para;</a></h3>
<p>Normalize activation keys by removing model prefixes.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">normalize_layer_key</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">normalize_layer_key</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="n">normalize_layer_key</span><span class="p">(</span><span class="s2">&quot;model.model.layers.0&quot;</span><span class="p">)</span>  <span class="c1"># &quot;layers.0&quot;</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="n">normalize_layer_key</span><span class="p">(</span><span class="s2">&quot;model.layers.5.self_attn&quot;</span><span class="p">)</span>  <span class="c1"># &quot;layers.5.self_attn&quot;</span>
</span></code></pre></div>
<hr />
<h3 id="function-find_layer_key_pattern">Function: <code>find_layer_key_pattern</code><a class="headerlink" href="#function-find_layer_key_pattern" title="Permanent link">&para;</a></h3>
<p>Find the correct activation key pattern for a layer index.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">find_layer_key_pattern</span><span class="p">(</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>    <span class="n">activations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="n">layer_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="n">component</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></code></pre></div>
<p><strong>Example:</strong></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_layer_key_pattern</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="c1"># Find layer 5&#39;s key in activations dict</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="n">key</span> <span class="o">=</span> <span class="n">find_layer_key_pattern</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">activations</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="c1"># Returns &quot;model.model.layers.5&quot; or &quot;layers.5&quot; etc.</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="c1"># Find specific component</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="n">key</span> <span class="o">=</span> <span class="n">find_layer_key_pattern</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">activations</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;self_attn&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="type-annotations">Type Annotations<a class="headerlink" href="#type-annotations" title="Permanent link">&para;</a></h2>
<p>Common types used in mlxterp:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.core</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mx</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">mlx.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="c1"># Input types</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="n">InputType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="c1"># Intervention function type</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="n">InterventionFn</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">mx</span><span class="o">.</span><span class="n">array</span><span class="p">]</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="c1"># Interventions dict</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="n">InterventionsDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">InterventionFn</span><span class="p">]</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="c1"># Model type</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="n">ModelType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span></code></pre></div>
<hr />
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="common-exceptions">Common Exceptions<a class="headerlink" href="#common-exceptions" title="Permanent link">&para;</a></h3>
<h4 id="valueerror"><code>ValueError</code><a class="headerlink" href="#valueerror" title="Permanent link">&para;</a></h4>
<p>Raised when:
- String input provided without tokenizer
- Invalid input format
- Model cannot be loaded from string</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1"># Will raise ValueError</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">base_model</span><span class="p">)</span>  <span class="c1"># No tokenizer</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;text input&quot;</span><span class="p">):</span>  <span class="c1"># Needs tokenizer!</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>    <span class="k">pass</span>
</span></code></pre></div>
<p><strong>Solution:</strong> Provide tokenizer</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">my_tokenizer</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="attributeerror"><code>AttributeError</code><a class="headerlink" href="#attributeerror" title="Permanent link">&para;</a></h4>
<p>Raised when:
- Accessing non-existent module attribute
- Layer attribute doesn't exist</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># Will raise AttributeError</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">custom_model</span><span class="p">,</span> <span class="n">layer_attr</span><span class="o">=</span><span class="s2">&quot;transformer&quot;</span><span class="p">)</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="c1"># If custom_model doesn&#39;t have &#39;transformer&#39; attribute</span>
</span></code></pre></div>
<p><strong>Solution:</strong> Specify correct layer attribute</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">InterpretableModel</span><span class="p">(</span><span class="n">custom_model</span><span class="p">,</span> <span class="n">layer_attr</span><span class="o">=</span><span class="s2">&quot;layers&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<h3 id="1-always-use-context-managers">1. Always Use Context Managers<a class="headerlink" href="#1-always-use-context-managers" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="c1">#  Good</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="n">act</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="c1">#  Avoid</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a><span class="n">trace</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="c1"># Missing context manager!</span>
</span></code></pre></div>
<h3 id="2-save-early-access-later">2. Save Early, Access Later<a class="headerlink" href="#2-save-early-access-later" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1">#  Good</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>    <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="c1"># Access after trace completes</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="n">act</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layers.3.output&quot;</span><span class="p">)</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="c1">#  Avoid trying to access during trace</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>    <span class="n">act</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;layers.3.output&quot;</span><span class="p">)</span>  <span class="c1"># Not saved yet!</span>
</span></code></pre></div>
<h3 id="3-use-utility-functions-for-common-tasks">3. Use Utility Functions for Common Tasks<a class="headerlink" href="#3-use-utility-functions-for-common-tasks" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="c1">#  Good - Use get_activations</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_activations</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">get_activations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prompts</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="c1">#  Avoid manual loops</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="n">acts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="k">for</span> <span class="n">layer_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>    <span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">prompts</span><span class="p">):</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>        <span class="n">acts</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer_idx</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="4-batch-large-datasets">4. Batch Large Datasets<a class="headerlink" href="#4-batch-large-datasets" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="c1">#  Good - Use batching</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">mlxterp</span><span class="w"> </span><span class="kn">import</span> <span class="n">batch_get_activations</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="n">acts</span> <span class="o">=</span> <span class="n">batch_get_activations</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">large_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="c1">#  Avoid loading everything at once</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="k">with</span> <span class="n">model</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">large_list</span><span class="p">):</span>  <span class="c1"># May run out of memory</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="n">acts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span></code></pre></div>
<hr />
<h2 id="version-history">Version History<a class="headerlink" href="#version-history" title="Permanent link">&para;</a></h2>
<h3 id="010-current">0.1.0 (Current)<a class="headerlink" href="#010-current" title="Permanent link">&para;</a></h3>
<ul>
<li>Initial release</li>
<li>Core tracing functionality</li>
<li>Intervention system</li>
<li>Basic utility functions</li>
<li>Support for any MLX model</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Sigurd Schacht
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/coairesearch/mlxterp" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/mlxterp/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>